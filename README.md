# Chaminade Email Newsletter Templates
[![UCM](https://img.shields.io/badge/Department-UCM-blue.svg)](https://www.chaminade.edu)  

A little inhouse email templating workflow based on [MJML](https://mjml.io/), [Handlebars](http://handlebarsjs.com/), and [Gulp](http://gulpjs.com/). Uses [Nodemailer](https://nodemailer.com/) for fast test emails. The templates already come with the necessary [AMPscript](https://help.marketingcloud.com/en/documentation/ampscript/ampscript_syntax_guide/) template strings for Salesforce Marketing Cloud. 

Just have to fill out `src/emailconfig.json` with email content, then select the appropriate template from `/templates` and feed it into gulp as parameters, for example: 
  ```
  gulp --data src/emailconfig.json --template templates/newsletter_master.hbs
  ```

Or you can pull it from Google Sheets using `gulp pulldata`, which populates `src/gsheets_emailconfig.json`. Then you can use that as your data source, i.e.:
  ```
  gulp --data src/gsheets_emailconfig.json --template templates/newsletter_master.hbs
  ```

This was made on and works on a Mac OSX. There are also several env variables needed for the other functionalities:
  
  - **Litmus**: `$LITMUS_EMAIL $LITMUS_PW`
  - **Get Employee Emails**: `$CUH_EMAIL_ENDPOINT $CUH_EMAIL_OAUTH`
  - **Send Test Emails**: `$TEST_EMAIL_LIST` Optional : `$CHAMINADE_EMAIL $CHAMINADE_PW`
  - **Pull Data from Google Sheets**: `/lib/gsheets/client_secret.json` (generated by Google Sheets API v4)


### How to Install
  ```
  git clone git@github.com:chaminade/ucm-email-templates.git && cd ucm-email-templates

  npm install  
  ```
  
## Gulp Task Overview:

### • Compile Email  
The `--data` and `--template` parameters are _REQUIRED_.

_Read first: If you change the `template.constituency` in `emailconfig.json`, you should run it twice to ensure all fields properly changed. Also `template.nameplate_image` and `template.masthead` will be overwritten, as `template.constituency` generates it._  

  ```
  gulp --data {src/emailconfig.json} --template {templates/templateName.hbs}
  ```

### • Resize and process images  
The `--hero` and `--size` parameters are _OPTIONAL_.  
Hero images default to `600px` wide and can be overridden with `--size`.
  ```
  gulp images [--hero src/images/{imagefile.jpg|png} --size ###]
  ```

### • Send test email
_Read first: Before you do this, you have to upload the images to Salesforce Marketing Cloud and use those CDN URIs for all image assets. The test email also does not fill in the `%%template%%` AMPscript tags. It is merely for layout and copy proofing._  

Sends out a test email via GMail via nodemailer. Asks you for your GMail credentials (not saved), email recipient, and template (from `/build` folder). Requires an env variable `$TEST_EMAIL_LIST` in the format `"email@address.edu,email@address.edu,[...]"` since Bash can't export arrays as env variables. Optional `$CHAMINADE_EMAIL` and `$CHAMINADE_PW` to autofill email credentials.
  ```
  gulp sendtestemail
  ```

### • Pull a fresh email list (for Faculty/Staff/Adjuncts)
Pulls an email list. This relies on a few env variables: `$CUH_EMAIL_ENDPOINT` for the CUH API URI for internal emails, and `$CUH_EMAIL_OAUTH` for the OAUTH token.
  ```
  gulp getemails
  ```

### • Pull email data from Google Sheets
This will pull content data from a specific Google Sheet at `https://docs.google.com/spreadsheets/d/1Re4xTadmIHnh5aNmxOM2YuAAMDKdrlfHtH4mZH2IoOE/` and write it into `src/gsheets_emailconfig.json`. The Google Sheet is an alternative to manually inputting data into the JSON file. This requires a `Client ID` and `Client Secret` from Google API to run (see the `_example_client_secret.json` in `lib/gsheets`).
  ```
  gulp pulldata
  ```

### • Test email with Litmus
Sends design to Litmus to test email rendering on various email clients, apps and browsers.
This requires env variables `$LITMUS_EMAIL` and `$LITMUS_PW` as login credentials to [Litmus](https://www.litmus.com).
  ```
  gulp litmus
  ```


## What Gulp doesn't do
- Right now, basically anything to do with Salesforce. It just builds out the HTML email itself.
  - Does not upload your images into Salesforce Marketing Cloud.
  - Does not create your emails in Salesforce Marketing Cloud either.
  - One currently has to clone a previous email in Salesforce (faster than from scratch), manually edit the email's Salesforce filename and the email subject, and use the GUI to formally send the email out. We pretty much use Salesforce only for the Sender Authentication Package and analytics (and maybe fancy segmenting and dynamic content with AMPscript in the future).

## Features to explore at a later date
- May be possible to connect to Salesforce Marketing Cloud via their [FUEL SDK for Node](https://github.com/salesforce-marketingcloud/FuelSDK-Node) to create and send emails automatically.
- Salesforce [AMPscript](https://help.marketingcloud.com/en/documentation/ampscript/ampscript_syntax_guide/) logic and integration features. Social Forwarding?
- Uploading and importing email lists to Salesforce Marketing Cloud automatically [may be possible with Enhanced FTP](http://www.degdigital.com/insights/exacttarget-training-automate-importing/). What about uploading images?